#!/usr/bin/env python3

import os
import sys
import shutil
import urllib.request

import git


SITE_URL = 'https://eyqs.ca'
REPO_REMOTE = 'origin'
BUILD_BRANCH = 'gh-pages'

REPO_ROOT = '/home/eugeneyqshen/web'
BUILD_FOLDER = '_site'
BLOG_FOLDER = 'blog'
ASSETS_FOLDER = 'assets'
BUILD_PATH = os.path.join(REPO_ROOT, BUILD_FOLDER)

ARCHIVE_URL = 'http://web.archive.org/save'
ARCHIVED_PAGES = ['about', 'blog', 'cakes', 'documents', 'sitemap']
ARCHIVED_POSTS = ['2001-first-post', '2002-ubcs-cpen', '2003-japn-trans']



def print_progress(message, func):
    print(f'{message}...', end='\r', flush=True)
    output = func()
    if type(output) == tuple:
        output = output[0]
    print(f'{message}: {output.strip()}', flush=True)

def create_directory(*args):
    directory = os.path.join(BUILD_PATH, *args)
    if not os.path.exists(directory):
        print_progress('Creating directory',
                lambda: (f'{os.path.join(BUILD_FOLDER, *args)}/',
                        os.mkdir(directory)))


def archive():

    print_progress('Archiving index', lambda: ('/',
            urllib.request.urlopen(f'{ARCHIVE_URL}/{SITE_URL}/')))

    for page in ARCHIVED_PAGES:
        page_url = f'{SITE_URL}/{page}'
        print_progress('Archiving page', lambda: (page,
                urllib.request.urlopen(f'{ARCHIVE_URL}/{page_url}/')))

    for post in ARCHIVED_POSTS:
        post_url = f'{SITE_URL}/{BLOG_FOLDER}/{post}'
        print_progress('Archiving post', lambda: (post,
                urllib.request.urlopen(f'{ARCHIVE_URL}/{post_url}/')))


def build():

    clean()
    create_directory()
    print_progress('Copying assets folder', lambda: (f'{ASSETS_FOLDER}/',
            shutil.copytree(os.path.join(REPO_ROOT, ASSETS_FOLDER),
                    os.path.join(BUILD_PATH, ASSETS_FOLDER))))


def clean():

    if os.path.exists(BUILD_PATH):
        print_progress('Removing build directory',
                lambda: (f'{BUILD_FOLDER}/', shutil.rmtree(BUILD_PATH)))
    else:
        print(f'Build directory does not exist: {BUILD_FOLDER}/')


def push():

    repo = git.Repo(REPO_ROOT)
    print_progress('Pushing to remote origin',
            lambda: repo.remotes.origin.push()[0].summary)
    print_progress('Pushing subtree to production',
            lambda: repo.git.subtree('push',
                    REPO_REMOTE, BUILD_BRANCH, prefix=BUILD_FOLDER))



def bad_input():
    print('Usage: ./web [archive|build|clean|push]')
    exit(1)

if __name__ == '__main__':

    if len(sys.argv) != 2:
        bad_input()

    os.chdir(REPO_ROOT)
    if sys.argv[1] == 'archive':
        archive()
    elif sys.argv[1] == 'build':
        build()
    elif sys.argv[1] == 'clean':
        clean()
    elif sys.argv[1] == 'push':
        push()
    else:
        bad_input()
